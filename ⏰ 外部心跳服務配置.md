# ⏰ 外部心跳服務配置指南

## 🎯 目的
防止 Render 免費版服務休眠,保持後端 24/7 在線

---

## ✅ 已實現的內部心跳

### 1. 自我 Ping 機制
- **間隔**: 每 10 分鐘
- **端點**: `GET /api/anon/v1/heartbeat`
- **日誌**: 控制台會顯示 `💓 心跳成功`

### 2. 健康檢查端點
- **端點**: `GET /health`
- **用途**: Render 官方推薦的健康檢查

---

## 🌐 推薦的外部心跳服務 (可選)

### 方案 1: UptimeRobot (推薦)
**免費額度**: 50 個監控,5 分鐘間隔

1. 註冊: https://uptimerobot.com
2. 添加新監控:
   - **類型**: HTTP(s)
   - **URL**: `https://amplifyx1688-backend.onrender.com/health`
   - **間隔**: 5 分鐘
   - **名稱**: SunExDmoe Backend

3. 設置通知 (可選):
   - Email
   - Telegram
   - Slack

### 方案 2: Cron-Job.org
**免費額度**: 無限監控,1 分鐘間隔

1. 註冊: https://cron-job.org
2. 創建新任務:
   - **URL**: `https://amplifyx1688-backend.onrender.com/api/anon/v1/heartbeat`
   - **間隔**: 每 5 分鐘
   - **方法**: GET

### 方案 3: Koyeb (完全免費)
**免費額度**: 無限,永久免費

1. 註冊: https://www.koyeb.com
2. 部署簡單的心跳服務:
```javascript
// heartbeat-service.js
const https = require('https');

setInterval(() => {
  https.get('https://amplifyx1688-backend.onrender.com/health', (res) => {
    console.log(`心跳: ${res.statusCode}`);
  });
}, 5 * 60 * 1000); // 5 分鐘
```

---

## 📊 心跳監控儀表板

### 查看心跳狀態:

**方法 1: 瀏覽器直接訪問**
```
https://amplifyx1688-backend.onrender.com/api/anon/v1/heartbeat
```

**方法 2: Render 控制台**
- 登入 Render Dashboard
- 進入服務 → Logs
- 搜索 "💓 心跳"

---

## 🔧 配置環境變量 (Render)

在 Render 服務設置中添加:

```
BACKEND_URL=https://amplifyx1688-backend.onrender.com
```

這會讓心跳機制使用正確的 URL

---

## 📈 性能影響

### 內部心跳:
- **CPU**: < 0.1%
- **內存**: < 1 MB
- **網絡**: 每 10 分鐘 < 1 KB

### 外部心跳 (推薦使用):
- **好處**: 即使後端掛了也能收到通知
- **壞處**: 需要額外註冊服務

---

## 🎯 最佳實踐

### 推薦配置:
1. **內部心跳**: 已啟用 ✅
2. **外部監控**: UptimeRobot (5 分鐘)
3. **健康檢查**: Render 官方 (已配置)

### 監控指標:
- **正常運行時間**: > 99%
- **響應時間**: < 1 秒
- **內存使用**: < 512 MB

---

## 🚨 故障排除

### 如果心跳失敗:

1. **檢查 Render 服務狀態**
   ```
   https://dashboard.render.com
   ```

2. **查看日誌**
   - 搜索 "❌ 心跳失敗"
   - 查看錯誤訊息

3. **手動重啟服務**
   - Render Dashboard → Manual Deploy

---

## 📝 日誌示例

### 正常心跳:
```
💓 心跳機制已啟動 - 每 10 分鐘自動 Ping 一次
💓 [2025-01-15T10:00:00.000Z] 發送心跳 Ping...
✅ [2025-01-15T10:00:00.123Z] 心跳成功 - 服務保持活躍
```

### 心跳失敗:
```
💓 [2025-01-15T10:00:00.000Z] 發送心跳 Ping...
❌ [2025-01-15T10:00:00.123Z] 心跳失敗: ECONNREFUSED
```

---

## ✅ 部署檢查清單

- [x] 內部心跳機制已添加
- [x] 心跳 API 端點已創建
- [x] 健康檢查端點已創建
- [ ] 推送到 GitHub
- [ ] Render 自動部署
- [ ] 驗證心跳正常工作
- [ ] (可選) 配置外部監控

---

**準備好部署了嗎?** 🚀

